import{r as e,V as Ce,u as Se,j as r,a as u,A as ct,b as Ke,K as $e,E as Re,Q as we,M as v,G as it,c as T,C as lt,d as ut,e as mt,f as dt,O as gt,g as ht,R as ft,h as pt}from"./index-BjywAXCu.js";const me=.02,Z=new Ce,Fe=new Ce,St=new u(0,-9.8,0);function Rt({platformNormal:o,platformRadius:t,platformThickness:d}){const c=e.useRef(null),i=e.useRef(new Ce).current,g=e.useCallback(()=>{i.set(0,0),Z.set(0,0),c.current&&c.current.position.set(0,me,0)},[i]);return e.useEffect(()=>(window.addEventListener("resetBall",g),()=>window.removeEventListener("resetBall",g)),[g]),Se((l,h)=>{if(!c.current||!o.current)return;const n=o.current,M=St.clone().projectOnPlane(n);Fe.set(M.x,M.z),Z.add(Fe.clone().multiplyScalar(h)),i.add(Z.clone().multiplyScalar(h));const E=i.length(),A=t-me;if(E>A){i.normalize().multiplyScalar(A);const P=i.clone().normalize().multiplyScalar(-1),N=Z.dot(P),p=Z.clone().sub(P.clone().multiplyScalar(2*N));Z.copy(p).multiplyScalar(.7)}Z.multiplyScalar(.995);const y=(-n.x*i.x-n.z*i.y)/n.y,q=d/2;c.current.position.set(i.x,y+me+q,i.y)}),r.jsxs("mesh",{ref:c,castShadow:!0,children:[r.jsx("sphereGeometry",{args:[me,32,32]}),r.jsx("meshStandardMaterial",{color:"orange",metalness:0,roughness:.5})]})}const wt=.01,We=.002,xt=.01,yt=-.0015-We/2;function Tt(){return r.jsxs("mesh",{"position-y":yt,children:[r.jsx("boxGeometry",{args:[wt,We,xt]}),r.jsx("meshStandardMaterial",{color:"#003366",metalness:.2,roughness:.6})]})}const _t=-Math.PI/2,vt=2/1e3,Mt=-13.33/1e3;function Et({position:o,rotationY:t,height:d,maxLift:c}){const i=d/c*180;return r.jsx("group",{position:o,"rotation-y":t,children:r.jsx("group",{position:[vt,0,Mt],"rotation-y":_t,children:r.jsx(ct,{servoAngle:i,maxLift:c})})})}const Je="/projects/platform/actuator-parts/ball.glb";function xe(o){const{nodes:t}=Ke(Je),d=Object.values(t).find(c=>c.isMesh);return d?r.jsx("group",{...o,dispose:null,children:r.jsx("mesh",{castShadow:!0,receiveShadow:!0,geometry:d.geometry,material:d.material})}):(console.error("No mesh was found inside /actuator-parts/ball.glb"),null)}Ke.preload(Je);const At=.037,pe=.005,Ie=.007,He=.0112,je=.03;function Ct({actuatorDistance:o}){const t=o+Ie+je,d=(-je+o+Ie)/2;return r.jsx("group",{children:$e.map((c,i)=>{const g=d*Math.cos(c),l=d*Math.sin(c),h=He*-Math.sin(c),n=He*Math.cos(c);return r.jsxs("mesh",{position:[g+h,pe/2,l+n],"rotation-y":-c,children:[r.jsx("boxGeometry",{args:[t,pe,At]}),r.jsx("meshStandardMaterial",{color:"#29b6f6",metalness:.1,roughness:.7})]},i)})})}const oe=new u,de=new u,ge=new u,De=new u,be=new u,Pe=new u,Le=new u,Oe=new u,ee=new u,ye=new we,Te=new Re(0,0,0,"YXZ"),ae=new u,Ft=new u(0,1,0),It=new u(0,-1,0),Ue=new u,Ne=new Re(0,0,0,"YXZ"),Ht=new u(0,1,0),he=new u,se=new we,_e=1e-6,ve=.085,ze=.003,jt=.05;function Dt({platformRadius:o,actuatorPositions:t,visualRotationAngles:d,actuatorHeights:c,targetRoll:i,targetPitch:g,controlMode:l,maxLift:h,levelingState:n,onPlatformUpdate:M}){const E=e.useRef(null),A=e.useRef(null),y=e.useRef(null),q=e.useRef(new u(0,1,0)),P=e.useRef(null),N=e.useRef(null),p=e.useRef(null);return Se(()=>{if(!E.current)return;const L=pe;oe.set(t[0].x,L+ve+c[0],t[0].z),de.set(t[1].x,L+ve+c[1],t[1].z),ge.set(t[2].x,L+ve+c[2],t[2].z),Le.subVectors(de,oe),Oe.subVectors(ge,oe),ee.crossVectors(Oe,Le).normalize(),q.current.copy(ee),ye.setFromUnitVectors(Ft,ee),E.current.setRotationFromQuaternion(ye),ae.copy(oe).add(de).add(ge).divideScalar(3);const C=new u().copy(ae);if(ee.y<.999){Ue.copy(It).projectOnPlane(ee).normalize();const G=1-ee.y;C.addScaledVector(Ue,G*jt)}E.current.position.copy(C),se.copy(ye).invert(),De.copy(oe).sub(ae).applyQuaternion(se),be.copy(de).sub(ae).applyQuaternion(se),Pe.copy(ge).sub(ae).applyQuaternion(se),P.current&&P.current.position.copy(De),N.current&&N.current.position.copy(be),p.current&&p.current.position.copy(Pe),y.current&&y.current.position.copy(C),A.current&&(Ne.set(v.degToRad(i),0,v.degToRad(g)),A.current.setRotationFromEuler(Ne),A.current.position.copy(C)),he.copy(Ht).applyQuaternion(se);let V=he.x,O=he.y,S=he.z;Math.abs(V)<_e&&(V=0),Math.abs(O)<_e&&(O=0),Math.abs(S)<_e&&(S=0);const w=Math.asin(-S),F=Math.atan2(V,O),I=v.degToRad(.02),K=w+(Math.random()-.5)*2*I,k=F+(Math.random()-.5)*2*I;Te.setFromQuaternion(E.current.quaternion,"YXZ"),M({realRoll:Te.x,realPitch:Te.z,imuRoll:K,imuPitch:k,ax:V,ay:O,az:S})}),r.jsxs(r.Fragment,{children:[r.jsxs("mesh",{ref:E,castShadow:!0,receiveShadow:!0,children:[r.jsx("cylinderGeometry",{args:[o,o,ze,64]}),r.jsx("meshStandardMaterial",{color:"#333",metalness:.1,roughness:.7}),r.jsx(Tt,{}),r.jsx("group",{ref:P,children:r.jsx(xe,{})}),r.jsx("group",{ref:N,children:r.jsx(xe,{})}),r.jsx("group",{ref:p,children:r.jsx(xe,{})})]}),r.jsxs("mesh",{ref:A,visible:l==="target"&&n!=="leveling",children:[r.jsx("cylinderGeometry",{args:[o,o,.001,64]}),r.jsx("meshStandardMaterial",{color:"royalblue",transparent:!0,opacity:.3,depthWrite:!1})]}),r.jsx("group",{ref:y,children:r.jsx(Rt,{platformNormal:q,platformRadius:o,platformThickness:ze})}),r.jsx(Ct,{actuatorDistance:t[0].length()}),t.map((L,C)=>r.jsx(Et,{position:L.clone().setY(pe),rotationY:d[C],height:c[C],maxLift:h},C))]})}function ce(o){const t=e.useRef(o);e.useEffect(()=>{t.current=o});const d=e.useRef(null),c=e.useRef(null),i=e.useRef(null),g=e.useRef(null),l=e.useRef(null),h=e.useRef(null),n=e.useRef({mode:o.controlMode,radius:o.platformRadius*1e3,distance:o.actuatorDistance*1e3,act1:o.manualHeights[0]*1e3,act2:o.manualHeights[1]*1e3,act3:o.manualHeights[2]*1e3,targetRoll:o.targetRoll,targetPitch:o.targetPitch,targetFactor:o.targetFactor,targetHeight:o.targetHeight*1e3,currentRoll:0,currentPitch:0,imu_ax:0,imu_ay:0,imu_az:0,imu_roll:0,imu_pitch:0,homingDownSpeed:o.homingDownSpeed,homingUpSpeed:o.homingUpSpeed});e.useEffect(()=>{const S=new it({title:"Platform Kinematics Simulator"});d.current=S;const w={levelPlatform:()=>t.current.levelPlatform(),runHoming:()=>t.current.runHomingSequence(),resetBall:()=>{t.current.onInteraction(),window.dispatchEvent(new Event("resetBall"))},toggleDeviceControl:()=>t.current.toggleDeviceControl()},F=S.addFolder("Control Mode"),I=S.addFolder("Platform Parameters");g.current=S.addFolder("Manual Actuator Controls"),l.current=S.addFolder("Target Angle Control");const K=S.addFolder("Real-Time Data"),k=S.addFolder("Simulated IMU (MPU6050)"),G=S.addFolder("System Actions");F.add(n.current,"mode",["manual","target"]).name("Mode").onChange(s=>{t.current.onInteraction(),t.current.setControlMode(s)}),I.add(n.current,"radius",50,250,1).name("Platform Radius (mm)").onChange(s=>{t.current.onInteraction(),t.current.setPlatformRadius(s/1e3)}),I.add(n.current,"distance",50,250,1).name("Actuator Distance (mm)").onChange(s=>{t.current.onInteraction(),t.current.setActuatorDistance(s/1e3)}),g.current.add(n.current,"act1",0,o.maxLift*1e3,.1).name("Actuator 1 (mm)").listen().onChange(s=>{t.current.onInteraction(),t.current.setManualHeights(H=>[s/1e3,H[1],H[2]])}),g.current.add(n.current,"act2",0,o.maxLift*1e3,.1).name("Actuator 2 (mm)").listen().onChange(s=>{t.current.onInteraction(),t.current.setManualHeights(H=>[H[0],s/1e3,H[2]])}),g.current.add(n.current,"act3",0,o.maxLift*1e3,.1).name("Actuator 3 (mm)").listen().onChange(s=>{t.current.onInteraction(),t.current.setManualHeights(H=>[H[0],H[1],s/1e3])}),c.current=g.current.add(w,"levelPlatform"),l.current.add(n.current,"targetRoll",-45,45,.1).name("Target Roll (°)").listen().onChange(s=>{t.current.onInteraction(),t.current.setTargetRoll(s)}),l.current.add(n.current,"targetPitch",-45,45,.1).name("Target Pitch (°)").listen().onChange(s=>{t.current.onInteraction(),t.current.setTargetPitch(s)}),l.current.add(n.current,"targetFactor",1,5,.1).name("Target Factor").listen().onChange(s=>{t.current.onInteraction(),t.current.setTargetFactor(s)}),l.current.add(n.current,"targetHeight",0,o.maxLift*1e3,.1).name("Target Height (mm)").listen().onChange(s=>{t.current.onInteraction(),t.current.setTargetHeight(s/1e3)}),i.current=l.current.add(w,"levelPlatform"),K.add(n.current,"currentRoll",-90,90,.1).name("Current Roll (°)").listen().disable(),K.add(n.current,"currentPitch",-90,90,.1).name("Current Pitch (°)").listen().disable();const te=k.addFolder("Raw Accelerometer Data (g)");te.add(n.current,"imu_ax",-1,1,.001).name("ax").listen().disable(),te.add(n.current,"imu_ay",-1,1,.001).name("ay").listen().disable(),te.add(n.current,"imu_az",-1,1,.001).name("az").listen().disable();const ie=k.addFolder("Calculated Angles");ie.add(n.current,"imu_roll",-90,90,.1).name("Roll (°)").listen().disable(),ie.add(n.current,"imu_pitch",-90,90,.1).name("Pitch (°)").listen().disable(),G.add(n.current,"homingDownSpeed",30,300,10).name("Homing Down Speed (deg/s)").listen().onChange(s=>{t.current.onInteraction(),t.current.setHomingDownSpeed(s)}),G.add(n.current,"homingUpSpeed",30,300,10).name("Homing Up Speed (deg/s)").listen().onChange(s=>{t.current.onInteraction(),t.current.setHomingUpSpeed(s)}),G.add(w,"runHoming").name("Run Homing Sequence"),G.add(w,"resetBall").name("Reset Ball"),"DeviceOrientationEvent"in window&&(h.current=G.add(w,"toggleDeviceControl").name("Enable Phone Control"));const Y=s=>Math.round(s*10)/10;return ce.update=(s,H,X,le,ue,Q,$)=>{n.current.currentRoll=Y(v.radToDeg(s)),n.current.currentPitch=Y(v.radToDeg(H)),n.current.imu_ax=ue,n.current.imu_ay=Q,n.current.imu_az=$,n.current.imu_roll=Y(v.radToDeg(X)),n.current.imu_pitch=Y(v.radToDeg(le))},()=>{ce.update=(()=>{}),S.destroy(),d.current=null}},[o.maxLift]);const{controlMode:M,platformRadius:E,actuatorDistance:A,manualHeights:y,targetRoll:q,targetPitch:P,targetFactor:N,homingDownSpeed:p,homingUpSpeed:L,targetHeight:C,levelingState:V,deviceControl:O}=o;return e.useEffect(()=>{n.current.mode=M,n.current.radius=E*1e3,n.current.distance=A*1e3,n.current.act1=y[0]*1e3,n.current.act2=y[1]*1e3,n.current.act3=y[2]*1e3,n.current.targetRoll=q,n.current.targetPitch=P,n.current.targetFactor=N,n.current.targetHeight=C*1e3,n.current.homingDownSpeed=p,n.current.homingUpSpeed=L},[M,E,A,y,q,P,N,p,L,C]),e.useEffect(()=>{g.current&&g.current.show(M==="manual"),l.current&&l.current.show(M==="target"),h.current&&h.current.name(O?"Disable Phone Control":"Enable Phone Control"),l.current&&l.current.controllers.forEach(F=>{const I=F.property;(I==="targetRoll"||I==="targetPitch")&&(F.domElement.style.pointerEvents=O?"none":"auto",F.domElement.style.opacity=O?"0.5":"1")});const S=V==="leveling",w=S?"Leveling...":"Level Platform";[c.current,i.current].forEach(F=>{F&&(F.name(w),F.domElement.style.pointerEvents=S?"none":"auto",F.domElement.style.opacity=S?"0.5":"1")})},[M,V,O]),null}ce.update=(()=>{});const bt=150/1e3,Pt=100/1e3,Ge=180,Lt=300,Me=T/180*Lt,ke=new Re(0,0,0,"YXZ"),Be=new we,qe=new u(0,1,0),Ee=new u,Ve=new u,Xe=new u,Qe=new u,Ye=new u,fe=new u,Ze=new we,Ae=new Re(0,0,0,"YXZ");function Ot({isIdle:o,controlsRef:t}){return Se((d,c)=>{if(o&&t.current){const i=t.current,g=i.target,l=d.camera,h=.3*c;l.position.sub(g),l.position.applyAxisAngle(new u(0,1,0),h),l.position.add(g),i.update()}}),null}const Ut=({deviceControlActive:o,controlsRef:t})=>{const d=ht(l=>l.camera),c=e.useRef(!1),i=e.useRef(o),g=e.useRef(new u(0,.2,.6)).current;return e.useEffect(()=>{o&&!i.current&&(c.current=!0),i.current=o},[o]),Se((l,h)=>{if(c.current&&t.current){const n=t.current;d.position.lerp(g,h*3),d.position.distanceTo(g)<.01&&(d.position.copy(g),c.current=!1),n.update()}}),null};function Nt(){const[o,t]=e.useState("manual"),[d,c]=e.useState(bt),[i,g]=e.useState(Pt),[l,h]=e.useState([T/2,T/2,T/2]),[n,M]=e.useState(0),[E,A]=e.useState(0),[y,q]=e.useState(2),[P,N]=e.useState(T/2),[p,L]=e.useState("idle"),[C,V]=e.useState(Ge),[O,S]=e.useState(Ge),[w,F]=e.useState("idle"),[I,K]=e.useState(T/2),[k,G]=e.useState(!1),[te]=e.useState("ontouchstart"in window),[ie,Y]=e.useState(!0),s=e.useRef(null),H=e.useRef(null),X=e.useRef({beta:null,gamma:null}),le=e.useCallback(()=>{Y(!1),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>Y(!0),1e4)},[]);e.useEffect(()=>()=>{s.current&&clearTimeout(s.current)},[]);const[ue]=e.useState(()=>[Me*(1-Math.random()*.05),Me*(1-Math.random()*.05),Me*(1-Math.random()*.05)]),Q=e.useRef(l);e.useEffect(()=>{Q.current=l},[l]);const $=e.useCallback(a=>{const{beta:f,gamma:m}=a;if(f!==null&&m!==null){(X.current.beta===null||X.current.gamma===null)&&(X.current.beta=f,X.current.gamma=m);const j=f-X.current.beta,_=m-X.current.gamma,R=v.clamp(j,-45,45),x=v.clamp(-_,-45,45);A(x),M(R)}},[]);e.useEffect(()=>(k?window.addEventListener("deviceorientation",$):window.removeEventListener("deviceorientation",$),()=>{window.removeEventListener("deviceorientation",$)}),[k,$]);const et=async()=>{if(k){G(!1),X.current={beta:null,gamma:null};return}const a=DeviceOrientationEvent;if(typeof a.requestPermission=="function")try{await a.requestPermission()==="granted"?(t("target"),G(!0)):alert("Permission to access device orientation was denied.")}catch(f){console.error("Error requesting device orientation permission:",f),alert("An error occurred while requesting permission.")}else t("target"),G(!0)},ne=e.useMemo(()=>$e.map(a=>new u(i*Math.cos(a),0,i*Math.sin(a))),[i]),re=e.useMemo(()=>{const a=v.degToRad(n/y),f=v.degToRad(E/y);ke.set(a,0,f),Be.setFromEuler(ke);const m=qe.clone().applyQuaternion(Be),j=ne.map(b=>-(m.x*b.x+m.z*b.z)/m.y),_=j.reduce((b,J)=>b+J,0)/3;let R=j.map(b=>b-_);const x=Math.min(...R),U=Math.max(...R);if(U-x>T){const b=T/(U-x);R=R.map(J=>J*b)}let B=R.map(b=>b+P);const D=Math.min(...B),z=Math.max(...B);let W=0;return D<0?W=-D:z>T&&(W=T-z),B=B.map(b=>b+W),B},[n,E,ne,y,P]),tt=e.useCallback(a=>{ce.update(a.realRoll,a.realPitch,a.imuRoll,a.imuPitch,a.ax,a.ay,a.az)},[]);e.useEffect(()=>{if(p==="idle"||p==="complete")return;let a,f;if(p==="homing_down"){let m=null;const j=C/180*T,_=T/j*1e3,R=x=>{m||(m=x);const U=(x-m)/1e3;m=x;const D=Q.current.map(z=>Math.max(0,z-j*U));h(D),a=requestAnimationFrame(R)};a=requestAnimationFrame(R),f=setTimeout(()=>{cancelAnimationFrame(a),h([0,0,0]),L("homing_up")},_)}else if(p==="homing_up"){let m=null;const j=O/180*T,_=T/2,R=x=>{m||(m=x);const U=(x-m)/1e3;m=x;const D=Q.current[0]+j*U;D>=_?(h([_,_,_]),L("complete")):(h([D,D,D]),a=requestAnimationFrame(R))};a=requestAnimationFrame(R)}return()=>{cancelAnimationFrame(a),f&&clearTimeout(f)}},[p,C,O]),e.useEffect(()=>{if(p==="complete"){const a=setTimeout(()=>L("idle"),500);return()=>clearTimeout(a)}},[p]);const nt=e.useCallback(()=>{p==="idle"&&w==="idle"&&(t("manual"),L("homing_down"))},[p,w]),rt=e.useCallback(()=>{if(w==="leveling"||p!=="idle"&&p!=="complete")return;const a=o==="manual"?Q.current:re;h(a);const f=(a[0]+a[1]+a[2])/3,m=v.clamp(f,0,T);K(m),N(m),F("leveling")},[o,p,re,w]);e.useEffect(()=>{if(w!=="leveling")return;let a,f=null;const m=2.5,j=1e-4,_=R=>{f||(f=R);const x=(R-f)/1e3;if(f=R,x>.1)return;const U=Q.current;let B=!0;const D=[...U];for(let z=0;z<3;z++){const W=I-U[z];if(Math.abs(W)>j){B=!1;const b=m*W*x,J=ue[z]*x,st=v.clamp(b,-J,J);D[z]+=st,D[z]=v.clamp(D[z],0,T)}}h(D),B?(h([I,I,I]),M(0),A(0),F("idle")):a=requestAnimationFrame(_)};return a=requestAnimationFrame(_),()=>cancelAnimationFrame(a)},[w,I,ue]);const ot=e.useCallback(a=>{if(a!==o){if(a==="target"){const[f,m,j]=Q.current,[_,R,x]=ne,U=.085;Ee.set(_.x,U+f,_.z),Ve.set(R.x,U+m,R.z),Xe.set(x.x,U+j,x.z),Qe.subVectors(Ve,Ee),Ye.subVectors(Xe,Ee),fe.crossVectors(Ye,Qe).normalize(),fe.y<0&&fe.negate(),Ze.setFromUnitVectors(qe,fe),Ae.setFromQuaternion(Ze,"YXZ"),M(v.radToDeg(Ae.x)*y),A(v.radToDeg(Ae.z)*y),N((f+m+j)/3)}else h(re);t(a)}},[o,ne,re,y]),at=w==="leveling"||o==="manual"?l:re;return r.jsxs(r.Fragment,{children:[r.jsx(ce,{controlMode:o,setControlMode:ot,platformRadius:d,setPlatformRadius:c,actuatorDistance:i,setActuatorDistance:g,manualHeights:l,setManualHeights:h,targetRoll:n,setTargetRoll:M,targetPitch:E,setTargetPitch:A,targetFactor:y,setTargetFactor:q,targetHeight:P,setTargetHeight:N,maxLift:T,homingDownSpeed:C,setHomingDownSpeed:V,homingUpSpeed:O,setHomingUpSpeed:S,runHomingSequence:nt,levelPlatform:rt,levelingState:w,onInteraction:le,deviceControl:k,toggleDeviceControl:et}),r.jsxs(lt,{shadows:!0,camera:{position:[.3,.25,.5],fov:50},children:[r.jsx(ut,{preset:"city"}),r.jsx("directionalLight",{position:[1,2,-1],intensity:1.5,castShadow:!0,"shadow-mapSize-width":2048,"shadow-mapSize-height":2048,"shadow-bias":-1e-4}),r.jsx("directionalLight",{position:[-10,10,5],intensity:.5}),r.jsx("ambientLight",{intensity:.5}),r.jsx(Dt,{platformRadius:d,actuatorPositions:ne,visualRotationAngles:mt,actuatorHeights:at,targetRoll:n,targetPitch:E,controlMode:o,maxLift:T,levelingState:w,onPlatformUpdate:tt}),r.jsxs("mesh",{"rotation-x":-Math.PI/2,"position-y":-1e-4,receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[5,5]}),r.jsx("shadowMaterial",{opacity:.5})]}),r.jsx(dt,{infiniteGrid:!0,sectionColor:"#505050",sectionSize:.1,fadeDistance:2,fadeStrength:1.5,"position-y":0}),r.jsx(gt,{ref:H,onStart:le,makeDefault:!0,minDistance:.27,maxDistance:1,target:[0,.07,0]}),r.jsx(Ut,{deviceControlActive:k,controlsRef:H}),!te&&r.jsx(Ot,{isIdle:ie,controlsRef:H})]})]})}ft.createRoot(document.getElementById("root")).render(r.jsx(pt.StrictMode,{children:r.jsx(Nt,{})}));

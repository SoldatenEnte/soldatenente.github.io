import{r as t,V as Te,u as _e,j as r,a as l,A as tt,b as qe,K as Xe,E as me,Q as ge,M as H,G as nt,c as R,C as rt,d as ot,e as at,f as st,O as ct,R as it,g as lt}from"./index-BngEeYwx.js";const se=.02,Z=new Te,Me=new Te,ut=new l(0,-9.8,0);function dt({platformNormal:o,platformRadius:n,platformThickness:h}){const c=t.useRef(null),i=t.useRef(new Te).current,f=t.useCallback(()=>{i.set(0,0),Z.set(0,0),c.current&&c.current.position.set(0,se,0)},[i]);return t.useEffect(()=>(window.addEventListener("resetBall",f),()=>window.removeEventListener("resetBall",f)),[f]),_e((d,e)=>{if(!c.current||!o.current)return;const w=o.current,N=ut.clone().projectOnPlane(w);Me.set(N.x,N.z),Z.add(Me.clone().multiplyScalar(e)),i.add(Z.clone().multiplyScalar(e));const _=i.length(),y=n-se;if(_>y){i.normalize().multiplyScalar(y);const v=i.clone().normalize().multiplyScalar(-1),b=Z.dot(v),m=Z.clone().sub(v.clone().multiplyScalar(2*b));Z.copy(m).multiplyScalar(.7)}Z.multiplyScalar(.995);const T=(-w.x*i.x-w.z*i.y)/w.y,k=h/2;c.current.position.set(i.x,T+se+k,i.y)}),r.jsxs("mesh",{ref:c,castShadow:!0,children:[r.jsx("sphereGeometry",{args:[se,32,32]}),r.jsx("meshStandardMaterial",{color:"orange",metalness:0,roughness:.5})]})}const mt=.01,Qe=.002,gt=.01,ht=-.0015-Qe/2;function ft(){return r.jsxs("mesh",{"position-y":ht,children:[r.jsx("boxGeometry",{args:[mt,Qe,gt]}),r.jsx("meshStandardMaterial",{color:"#003366",metalness:.2,roughness:.6})]})}const pt=-Math.PI/2,St=2/1e3,Rt=-13.33/1e3;function xt({position:o,rotationY:n,height:h,maxLift:c}){const i=h/c*180;return r.jsx("group",{position:o,"rotation-y":n,children:r.jsx("group",{position:[St,0,Rt],"rotation-y":pt,children:r.jsx(tt,{servoAngle:i,maxLift:c})})})}const Ye="/projects/platform/actuator-parts/ball.glb";function he(o){const{nodes:n}=qe(Ye),h=Object.values(n).find(c=>c.isMesh);return h?r.jsx("group",{...o,dispose:null,children:r.jsx("mesh",{castShadow:!0,receiveShadow:!0,geometry:h.geometry,material:h.material})}):(console.error("No mesh was found inside /actuator-parts/ball.glb"),null)}qe.preload(Ye);const wt=.037,de=.005,Ae=.007,Fe=.0112,Ie=.03;function yt({actuatorDistance:o}){const n=o+Ae+Ie,h=(-Ie+o+Ae)/2;return r.jsx("group",{children:Xe.map((c,i)=>{const f=h*Math.cos(c),d=h*Math.sin(c),e=Fe*-Math.sin(c),w=Fe*Math.cos(c);return r.jsxs("mesh",{position:[f+e,de/2,d+w],"rotation-y":-c,children:[r.jsx("boxGeometry",{args:[n,de,wt]}),r.jsx("meshStandardMaterial",{color:"#29b6f6",metalness:.1,roughness:.7})]},i)})})}const ee=new l,ce=new l,ie=new l,Ee=new l,He=new l,ve=new l,Ce=new l,je=new l,J=new l,fe=new ge,pe=new me(0,0,0,"YXZ"),te=new l,Tt=new l(0,1,0),_t=new l(0,-1,0),Pe=new l,De=new me(0,0,0,"YXZ"),Mt=new l(0,1,0),le=new l,ne=new ge,Se=1e-6,Re=.085,Le=.003,At=.05;function Ft({platformRadius:o,actuatorPositions:n,visualRotationAngles:h,actuatorHeights:c,targetRoll:i,targetPitch:f,controlMode:d,maxLift:e,levelingState:w,onPlatformUpdate:N}){const _=t.useRef(null),y=t.useRef(null),T=t.useRef(null),k=t.useRef(new l(0,1,0)),v=t.useRef(null),b=t.useRef(null),m=t.useRef(null);return _e(()=>{if(!_.current)return;const C=de;ee.set(n[0].x,C+Re+c[0],n[0].z),ce.set(n[1].x,C+Re+c[1],n[1].z),ie.set(n[2].x,C+Re+c[2],n[2].z),Ce.subVectors(ce,ee),je.subVectors(ie,ee),J.crossVectors(je,Ce).normalize(),k.current.copy(J),fe.setFromUnitVectors(Tt,J),_.current.setRotationFromQuaternion(fe),te.copy(ee).add(ce).add(ie).divideScalar(3);const u=new l().copy(te);if(J.y<.999){Pe.copy(_t).projectOnPlane(J).normalize();const V=1-J.y;u.addScaledVector(Pe,V*At)}_.current.position.copy(u),ne.copy(fe).invert(),Ee.copy(ee).sub(te).applyQuaternion(ne),He.copy(ce).sub(te).applyQuaternion(ne),ve.copy(ie).sub(te).applyQuaternion(ne),v.current&&v.current.position.copy(Ee),b.current&&b.current.position.copy(He),m.current&&m.current.position.copy(ve),T.current&&T.current.position.copy(u),y.current&&(De.set(H.degToRad(i),0,H.degToRad(f)),y.current.setRotationFromEuler(De),y.current.position.copy(u)),le.copy(Mt).applyQuaternion(ne);let j=le.x,A=le.y,z=le.z;Math.abs(j)<Se&&(j=0),Math.abs(A)<Se&&(A=0),Math.abs(z)<Se&&(z=0);const p=Math.asin(-z),q=Math.atan2(j,A),P=H.degToRad(.02),X=p+(Math.random()-.5)*2*P,K=q+(Math.random()-.5)*2*P;pe.setFromQuaternion(_.current.quaternion,"YXZ"),N({realRoll:pe.x,realPitch:pe.z,imuRoll:X,imuPitch:K,ax:j,ay:A,az:z})}),r.jsxs(r.Fragment,{children:[r.jsxs("mesh",{ref:_,castShadow:!0,receiveShadow:!0,children:[r.jsx("cylinderGeometry",{args:[o,o,Le,64]}),r.jsx("meshStandardMaterial",{color:"#333",metalness:.1,roughness:.7}),r.jsx(ft,{}),r.jsx("group",{ref:v,children:r.jsx(he,{})}),r.jsx("group",{ref:b,children:r.jsx(he,{})}),r.jsx("group",{ref:m,children:r.jsx(he,{})})]}),r.jsxs("mesh",{ref:y,visible:d==="target"&&w!=="leveling",children:[r.jsx("cylinderGeometry",{args:[o,o,.001,64]}),r.jsx("meshStandardMaterial",{color:"royalblue",transparent:!0,opacity:.3,depthWrite:!1})]}),r.jsx("group",{ref:T,children:r.jsx(dt,{platformNormal:k,platformRadius:o,platformThickness:Le})}),r.jsx(yt,{actuatorDistance:n[0].length()}),n.map((C,u)=>r.jsx(xt,{position:C.clone().setY(de),rotationY:h[u],height:c[u],maxLift:e},u))]})}function re(o){const n=t.useRef(o);t.useEffect(()=>{n.current=o});const h=t.useRef(null),c=t.useRef(null),i=t.useRef(null),f=t.useRef(null),d=t.useRef(null),e=t.useRef({mode:o.controlMode,radius:o.platformRadius*1e3,distance:o.actuatorDistance*1e3,act1:o.manualHeights[0]*1e3,act2:o.manualHeights[1]*1e3,act3:o.manualHeights[2]*1e3,targetRoll:o.targetRoll,targetPitch:o.targetPitch,targetFactor:o.targetFactor,targetHeight:o.targetHeight*1e3,currentRoll:0,currentPitch:0,imu_ax:0,imu_ay:0,imu_az:0,imu_roll:0,imu_pitch:0,homingDownSpeed:o.homingDownSpeed,homingUpSpeed:o.homingUpSpeed});t.useEffect(()=>{const u=new nt({title:"Platform Kinematics Simulator"});h.current=u;const j={levelPlatform:()=>n.current.levelPlatform(),runHoming:()=>n.current.runHomingSequence(),resetBall:()=>{n.current.onInteraction(),window.dispatchEvent(new Event("resetBall"))}},A=u.addFolder("Control Mode"),z=u.addFolder("Platform Parameters");f.current=u.addFolder("Manual Actuator Controls"),d.current=u.addFolder("Target Angle Control");const p=u.addFolder("Real-Time Data"),q=u.addFolder("Simulated IMU (MPU6050)"),P=u.addFolder("System Actions");A.add(e.current,"mode",["manual","target"]).name("Mode").onChange(s=>{n.current.onInteraction(),n.current.setControlMode(s)}),z.add(e.current,"radius",50,250,1).name("Platform Radius (mm)").onChange(s=>{n.current.onInteraction(),n.current.setPlatformRadius(s/1e3)}),z.add(e.current,"distance",50,250,1).name("Actuator Distance (mm)").onChange(s=>{n.current.onInteraction(),n.current.setActuatorDistance(s/1e3)}),f.current.add(e.current,"act1",0,o.maxLift*1e3,.1).name("Actuator 1 (mm)").listen().onChange(s=>{n.current.onInteraction(),n.current.setManualHeights(D=>[s/1e3,D[1],D[2]])}),f.current.add(e.current,"act2",0,o.maxLift*1e3,.1).name("Actuator 2 (mm)").listen().onChange(s=>{n.current.onInteraction(),n.current.setManualHeights(D=>[D[0],s/1e3,D[2]])}),f.current.add(e.current,"act3",0,o.maxLift*1e3,.1).name("Actuator 3 (mm)").listen().onChange(s=>{n.current.onInteraction(),n.current.setManualHeights(D=>[D[0],D[1],s/1e3])}),c.current=f.current.add(j,"levelPlatform"),d.current.add(e.current,"targetRoll",-45,45,.1).name("Target Roll (°)").listen().onChange(s=>{n.current.onInteraction(),n.current.setTargetRoll(s)}),d.current.add(e.current,"targetPitch",-45,45,.1).name("Target Pitch (°)").listen().onChange(s=>{n.current.onInteraction(),n.current.setTargetPitch(s)}),d.current.add(e.current,"targetFactor",1,5,.1).name("Target Factor").listen().onChange(s=>{n.current.onInteraction(),n.current.setTargetFactor(s)}),d.current.add(e.current,"targetHeight",0,o.maxLift*1e3,.1).name("Target Height (mm)").listen().onChange(s=>{n.current.onInteraction(),n.current.setTargetHeight(s/1e3)}),i.current=d.current.add(j,"levelPlatform"),p.add(e.current,"currentRoll",-90,90,.1).name("Current Roll (°)").listen().disable(),p.add(e.current,"currentPitch",-90,90,.1).name("Current Pitch (°)").listen().disable();const X=q.addFolder("Raw Accelerometer Data (g)");X.add(e.current,"imu_ax",-1,1,.001).name("ax").listen().disable(),X.add(e.current,"imu_ay",-1,1,.001).name("ay").listen().disable(),X.add(e.current,"imu_az",-1,1,.001).name("az").listen().disable();const K=q.addFolder("Calculated Angles");K.add(e.current,"imu_roll",-90,90,.1).name("Roll (°)").listen().disable(),K.add(e.current,"imu_pitch",-90,90,.1).name("Pitch (°)").listen().disable(),P.add(e.current,"homingDownSpeed",30,300,10).name("Homing Down Speed (deg/s)").listen().onChange(s=>{n.current.onInteraction(),n.current.setHomingDownSpeed(s)}),P.add(e.current,"homingUpSpeed",30,300,10).name("Homing Up Speed (deg/s)").listen().onChange(s=>{n.current.onInteraction(),n.current.setHomingUpSpeed(s)}),P.add(j,"runHoming").name("Run Homing Sequence"),P.add(j,"resetBall").name("Reset Ball");const V=s=>Math.round(s*10)/10;return re.update=(s,D,oe,ae,B,Q,Y)=>{e.current.currentRoll=V(H.radToDeg(s)),e.current.currentPitch=V(H.radToDeg(D)),e.current.imu_ax=B,e.current.imu_ay=Q,e.current.imu_az=Y,e.current.imu_roll=V(H.radToDeg(oe)),e.current.imu_pitch=V(H.radToDeg(ae))},()=>{re.update=(()=>{}),u.destroy(),h.current=null}},[o.maxLift]);const{controlMode:w,platformRadius:N,actuatorDistance:_,manualHeights:y,targetRoll:T,targetPitch:k,targetFactor:v,homingDownSpeed:b,homingUpSpeed:m,targetHeight:C}=o;return t.useEffect(()=>{e.current.mode=w,e.current.radius=N*1e3,e.current.distance=_*1e3,e.current.act1=y[0]*1e3,e.current.act2=y[1]*1e3,e.current.act3=y[2]*1e3,e.current.targetRoll=T,e.current.targetPitch=k,e.current.targetFactor=v,e.current.targetHeight=C*1e3,e.current.homingDownSpeed=b,e.current.homingUpSpeed=m},[w,N,_,y,T,k,v,b,m,C]),t.useEffect(()=>{const{controlMode:u,levelingState:j}=o;f.current&&f.current.show(u==="manual"),d.current&&d.current.show(u==="target");const A=j==="leveling",z=A?"Leveling...":"Level Platform";[c.current,i.current].forEach(p=>{p&&(p.name(z),p.domElement.style.pointerEvents=A?"none":"auto",p.domElement.style.opacity=A?"0.5":"1")})},[o.controlMode,o.levelingState]),null}re.update=(()=>{});const It=150/1e3,Et=100/1e3,be=180,Ht=300,xe=R/180*Ht,Oe=new me(0,0,0,"YXZ"),Ue=new ge,Ne=new l(0,1,0),we=new l,ze=new l,Ge=new l,ke=new l,Ve=new l,ue=new l,Be=new ge,ye=new me(0,0,0,"YXZ");function vt({isIdle:o,controlsRef:n}){return _e((h,c)=>{if(o&&n.current){const i=n.current,f=i.target,d=h.camera,e=.3*c;d.position.sub(f),d.position.applyAxisAngle(new l(0,1,0),e),d.position.add(f),i.update()}}),null}function Ct(){const[o,n]=t.useState("manual"),[h,c]=t.useState(It),[i,f]=t.useState(Et),[d,e]=t.useState([R/2,R/2,R/2]),[w,N]=t.useState(0),[_,y]=t.useState(0),[T,k]=t.useState(2),[v,b]=t.useState(R/2),[m,C]=t.useState("idle"),[u,j]=t.useState(be),[A,z]=t.useState(be),[p,q]=t.useState("idle"),[P,X]=t.useState(R/2),[K,V]=t.useState(!0),s=t.useRef(null),D=t.useRef(null),oe=t.useCallback(()=>{V(!1),s.current&&clearTimeout(s.current),s.current=setTimeout(()=>V(!0),1e4)},[]);t.useEffect(()=>()=>{s.current&&clearTimeout(s.current)},[]);const[ae]=t.useState(()=>[xe*(1-Math.random()*.05),xe*(1-Math.random()*.05),xe*(1-Math.random()*.05)]),B=t.useRef(d);t.useEffect(()=>{B.current=d},[d]);const Q=t.useMemo(()=>Xe.map(a=>new l(i*Math.cos(a),0,i*Math.sin(a))),[i]),Y=t.useMemo(()=>{const a=H.degToRad(w/T),M=H.degToRad(_/T);Oe.set(a,0,M),Ue.setFromEuler(Oe);const g=Ne.clone().applyQuaternion(Ue),O=Q.map(E=>-(g.x*E.x+g.z*E.z)/g.y),F=O.reduce((E,W)=>E+W,0)/3;let S=O.map(E=>E-F);const x=Math.min(...S),L=Math.max(...S);if(L-x>R){const E=R/(L-x);S=S.map(W=>W*E)}let G=S.map(E=>E+v);const I=Math.min(...G),U=Math.max(...G);let $=0;return I<0?$=-I:U>R&&($=R-U),G=G.map(E=>E+$),G},[w,_,Q,T,v]),Ze=t.useCallback(a=>{re.update(a.realRoll,a.realPitch,a.imuRoll,a.imuPitch,a.ax,a.ay,a.az)},[]);t.useEffect(()=>{if(m==="idle"||m==="complete")return;let a,M;if(m==="homing_down"){let g=null;const O=u/180*R,F=R/O*1e3,S=x=>{g||(g=x);const L=(x-g)/1e3;g=x;const I=B.current.map(U=>Math.max(0,U-O*L));e(I),a=requestAnimationFrame(S)};a=requestAnimationFrame(S),M=setTimeout(()=>{cancelAnimationFrame(a),e([0,0,0]),C("homing_up")},F)}else if(m==="homing_up"){let g=null;const O=A/180*R,F=R/2,S=x=>{g||(g=x);const L=(x-g)/1e3;g=x;const I=B.current[0]+O*L;I>=F?(e([F,F,F]),C("complete")):(e([I,I,I]),a=requestAnimationFrame(S))};a=requestAnimationFrame(S)}return()=>{cancelAnimationFrame(a),M&&clearTimeout(M)}},[m,u,A]),t.useEffect(()=>{if(m==="complete"){const a=setTimeout(()=>C("idle"),500);return()=>clearTimeout(a)}},[m]);const Ke=t.useCallback(()=>{m==="idle"&&p==="idle"&&(n("manual"),C("homing_down"))},[m,p]),$e=t.useCallback(()=>{if(p==="leveling"||m!=="idle"&&m!=="complete")return;const a=o==="manual"?B.current:Y;e(a);const M=(a[0]+a[1]+a[2])/3,g=H.clamp(M,0,R);X(g),b(g),q("leveling")},[o,m,Y,p]);t.useEffect(()=>{if(p!=="leveling")return;let a,M=null;const g=2.5,O=1e-4,F=S=>{M||(M=S);const x=(S-M)/1e3;if(M=S,x>.1)return;const L=B.current;let G=!0;const I=[...L];for(let U=0;U<3;U++){const $=P-L[U];if(Math.abs($)>O){G=!1;const E=g*$*x,W=ae[U]*x,et=H.clamp(E,-W,W);I[U]+=et,I[U]=H.clamp(I[U],0,R)}}e(I),G?(e([P,P,P]),N(0),y(0),q("idle")):a=requestAnimationFrame(F)};return a=requestAnimationFrame(F),()=>cancelAnimationFrame(a)},[p,P,ae]);const We=t.useCallback(a=>{if(a!==o){if(a==="target"){const[M,g,O]=B.current,[F,S,x]=Q,L=.085;we.set(F.x,L+M,F.z),ze.set(S.x,L+g,S.z),Ge.set(x.x,L+O,x.z),ke.subVectors(ze,we),Ve.subVectors(Ge,we),ue.crossVectors(Ve,ke).normalize(),ue.y<0&&ue.negate(),Be.setFromUnitVectors(Ne,ue),ye.setFromQuaternion(Be,"YXZ"),N(H.radToDeg(ye.x)*T),y(H.radToDeg(ye.z)*T),b((M+g+O)/3)}else e(Y);n(a)}},[o,Q,Y,T]),Je=p==="leveling"||o==="manual"?d:Y;return r.jsxs(r.Fragment,{children:[r.jsx(re,{controlMode:o,setControlMode:We,platformRadius:h,setPlatformRadius:c,actuatorDistance:i,setActuatorDistance:f,manualHeights:d,setManualHeights:e,targetRoll:w,setTargetRoll:N,targetPitch:_,setTargetPitch:y,targetFactor:T,setTargetFactor:k,targetHeight:v,setTargetHeight:b,maxLift:R,homingDownSpeed:u,setHomingDownSpeed:j,homingUpSpeed:A,setHomingUpSpeed:z,runHomingSequence:Ke,levelPlatform:$e,levelingState:p,onInteraction:oe}),r.jsxs(rt,{shadows:!0,camera:{position:[.3,.25,.5],fov:50},children:[r.jsx(ot,{preset:"city"}),r.jsx("directionalLight",{position:[1,2,-1],intensity:1.5,castShadow:!0,"shadow-mapSize-width":2048,"shadow-mapSize-height":2048,"shadow-bias":-1e-4}),r.jsx("directionalLight",{position:[-10,10,5],intensity:.5}),r.jsx("ambientLight",{intensity:.5}),r.jsx(Ft,{platformRadius:h,actuatorPositions:Q,visualRotationAngles:at,actuatorHeights:Je,targetRoll:w,targetPitch:_,controlMode:o,maxLift:R,levelingState:p,onPlatformUpdate:Ze}),r.jsxs("mesh",{"rotation-x":-Math.PI/2,"position-y":-1e-4,receiveShadow:!0,children:[r.jsx("planeGeometry",{args:[5,5]}),r.jsx("shadowMaterial",{opacity:.5})]}),r.jsx(st,{infiniteGrid:!0,sectionColor:"#505050",sectionSize:.1,fadeDistance:2,fadeStrength:1.5,"position-y":0}),r.jsx(ct,{ref:D,onStart:oe,makeDefault:!0,minDistance:.27,maxDistance:1,target:[0,.07,0]}),r.jsx(vt,{isIdle:K,controlsRef:D})]})]})}it.createRoot(document.getElementById("root")).render(r.jsx(lt.StrictMode,{children:r.jsx(Ct,{})}));
